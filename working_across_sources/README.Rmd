---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "",
  message = FALSE,
  warning = FALSE,
  out.width = "100%", 
  dpi = 300
)

```


# Building One Continuous Time Series

##### Joining NOAA and Marine Biological Association CPR Data

As mentioned in the top-level README, slight differences in units and development stage classifications prevent a direct join of Gulf of Maine CPR data collected & stored by NOAA and its parallel data that is obtained from the Marine Biological Association.

The data reshaping steps for working with these two data sources can be shown using data directly from ERDDAP.

For user-convenience these steps have been detailed below:

```{r, eval = TRUE}
# Load targets package
library(targets)

# Data manipulaiton packages
library(tidyverse)

# helper for not in
`%nin%` <- function(x, table){ is.na(match(x, table, nomatch = NA_integer_))}

# Temporary paths to targets instead of ERDDAP

# NOAA Sourced Years
withr::with_dir(rprojroot::find_root('_targets.R'),         
                tar_load("noaa_zp_erddap"))
# withr::with_dir(rprojroot::find_root('_targets.R'),         
#                 tar_load("noaa_phyto_erddap"))


# MBA Sourced Years
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load("mba_zpe_erddap"))
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load("mba_zpt_erddap"))


# Reformat data types for later
noaa_zooplankton_erddap <- noaa_zooplankton_erddap %>% 
  mutate(
    transect_number = as.character(transect_number),
    abundance = as.numeric(abundance))


```


```{r, eval = FALSE}
# ERDDAP Access Points
library(rerddap)

# Load data reshaping packages
library(tidyverse)

# helper for not in
`%nin%` <- function(x, table){ is.na(match(x, table, nomatch = NA_integer_))}


# 1. NOAA Zooplankton
# Get the tabledap information from the server link and dataset_id
cpr_info <- info(url = "http://ismn.erddap.neracoos.org/erddap", 
                 datasetid = "noaa_gom_cpr_zooplankton")

# Use the tabledap function to import all the data (optionally add filters)
noaa_zooplankton_erddap <- tabledap(cpr_info)

# Reformat data types for later
noaa_zooplankton_erddap <- noaa_zooplankton_erddap %>% 
  mutate(
    transect_number = as.character(transect_number),
    abundance = as.numeric(abundance))


# 2. MBA Traverse
cpr_info <- info(url = "http://ismn.erddap.neracoos.org/erddap", 
                 datasetid = "mba_gom_cpr_traverse")
mba_traverse_erddap <- tabledap(cpr_info)

# 2. MBA Eyecount
cpr_info <- info(url = "http://ismn.erddap.neracoos.org/erddap", 
                 datasetid = "mba_gom_cpr_eyecount")
mba_eyecount_erddap <- tabledap(cpr_info)



```

# Prepare MBA Data

Since the NOAA dataset contains the bulk of the ~50 year history for this CPR transect it is easiest to coerce the few years of the MBA data into a format that matches that of the NOAA data



## 1. Combine Zooplankton Data for MBA

Data from the MBA preserves the two measurement scales that the zooplankton data is recorded in which relate to the overall size of the zooplankton taxa. To get total zooplankton abundances we need to first combine the "eyecount" and "traverse" data into one zooplankton abundance dataset.

In general there is very little overlap where a taxa would be "double-counted", making this step a simple append. As a check against instances where there may be abundance data at both scales, I rename the columns before joining them to preserve the source scale. Then I can total the abundances to get an aggregate total (typically this step does not change the values as x + 0 = x)

```{r}

# The original code was in its wide-format, and with that format the metadata was in the first ten columns

# What we can do instead with the long format is rename abundance and abundance_per_transect of the one of them, merge, then add them to get totals
mba_eye <- rename(mba_eyecount_erddap,
                  abund_eyecount = abundance, 
                  transect_abund_eyecount = abundance_per_transect)
mba_trav <- rename(mba_traverse_erddap, 
                   abund_traverse = abundance, 
                   transect_abund_traverse = abundance_per_transect)
 
# Once the abundance columns are no longer in conflict we can merge them on taxa_id numbers etc.
mba_zoo <- full_join(
  x = mba_trav, 
  y = mba_eye, 
  by = c("cruise", "transect_number", "time", "latitude", "longitude", "pci", "taxon", "mba_id") # Erddap names
)
 

# Total the abundances from traverse and eyecount scales where possible
mba_zooplankton <- mba_zoo %>% 
  mutate(
    # Replace NA values with zeros
    abund_eyecount          = ifelse(is.na(abund_eyecount), 0, abund_eyecount),
    transect_abund_eyecount = ifelse(is.na(transect_abund_eyecount), 0, transect_abund_eyecount),
    abund_traverse          = ifelse(is.na(abund_traverse), 0, abund_traverse),
    transect_abund_traverse = ifelse(is.na(transect_abund_traverse), 0, transect_abund_traverse),
    # Sum them to get total abundances
    abundance_per_transect = transect_abund_traverse + transect_abund_eyecount,
    abundance              = abund_traverse + abund_eyecount) 

# Now drop the columns used as stand-ins 
# for combining the measurement scales
mba_zooplankton <- mba_zooplankton %>% 
  select(-c(abund_eyecount, abund_traverse, transect_abund_eyecount, transect_abund_traverse))
 


# Clean up environment
rm(mba_eye, mba_eyecount_erddap, mba_trav, mba_traverse_erddap, mba_zoo)
```


At this point we now have one dataframe containing the zooplankton abundance data from each of the two data sources.


## 2. Get Stage Information for MBA Data

The MBA data comes with the taxonomic name and the development stage information stored in the same field. To increase the usability and the ability to query specific groups it helps to separate these to pieces of information.


### Taxa Separation (MBA)


```{r}
# Use function to split the taxon from the stages:
source(here::here("targets_r/targets_support.R"))

# Function iterates on each word in the MBA taxon names to flag when the taxon name ends and stage info begins
mba_taxasplit <- separate_taxastage(mba_zooplankton)



```



# Matching Development Stage Groupings

Now that there exists a combined zooplankton abundance table for both NOAA and MBA data, the next step is to ensure that the taxonomic name and development stages can be added together for a proper estimation of abundances.

Throughout the time series varying levels of skill and expertise among researchers. This variability in confidently and accurately identifying taxa and their correct life-stage has resulted in some inconsistent groupings through time. When looking at the overall community it is often not necessary to have the exact life stage identified, and a more relaxed characterization will suffice.

The next two sections detail the history and nuances of the different data sources, and some code to supplement each one to make a more user-friendly product.



## MBA Taxonomic ID's

The identifiers used by the MBA are from the [Aphia Taxonomic Platform](), and the [World Register of Marine Species](). This resource has an R package: [{worrms}]() that can be used to look up taxonomic ID numbers from their names.

```{r}

# Package to interface with 
library(worrms)

# is the id number an aphia ID? NO
# Can we get the Aphia ID anyways, mostly
mba_aphia <- mba_taxasplit %>% 
  split(.$taxa) %>% 
  imap_dfr(function(x, y){
    try()
    aphia_id = try(expr = wm_name2id(name = y), silent = TRUE)
    aphia_id <- ifelse(class(aphia_id) == "try-error", NA, aphia_id)
    x_out <- mutate(x, aphia_id = aphia_id, .after = "mba_id")
    return(x_out)}) %>% 
  arrange(time, cruise, transect_number, taxa)

```



##  NOAA Taxonomic ID's

Data in the NOAA database uses identification ID's that are consistent with its [MARMAP Program](https://www.fisheries.noaa.gov/feature-story/monitoring-decade-learning-about-future-past#:~:text=The%20%E2%80%9CMARMAP%20Decade%E2%80%9D%20ran%20from,the%20Northeast%20Fisheries%20Science%20Center.), a shelf-wide monitoring program that ran from 1977-1988.

These codes identify each taxon specifically, with an additional code for what development stage it exhibits. 


```{r}
# Do the same Aphia ID Check for the NOAA taxa
noaa_aphia <- noaa_zooplankton_erddap %>% 
  split(.$taxa) %>% 
  imap_dfr(function(x, y){
    try()
    aphia_id = try(expr = wm_name2id(name = y), silent = TRUE)
    aphia_id <- ifelse(class(aphia_id) == "try-error", NA, aphia_id)
    x_out <- mutate(x, aphia_id = aphia_id, .after = "marmap_stage")
    return(x_out)}) %>% 
  arrange(time, cruise, transect_number, taxa)

# Drop "copepodite" from the stage because it is redundant
noaa_aphia <- noaa_aphia %>% 
  mutate(taxon_stage = str_replace_all(taxon_stage, "copepodite ", ""))

```



# Build One Continuous Time Series

```{r}
# Drop columns that only apply to one data set or the other:
mba_prepped <- mba_aphia %>% select(-c(mba_id, abundance_per_transect))
noaa_prepped <- noaa_aphia %>% select(-c(marmap_code, marmap_stage))

# Drop data with caveats or incorrect/missing information
noaa_prepped <- noaa_prepped %>% 
  mutate(abundance = ifelse(abundance == -9999, NA, abundance)) 


# Format column types
mba_prepped <- mutate(mba_prepped, pci = as.character(pci))

# Append full timeseries
gulfofmaine_full <- bind_rows(noaa_prepped, mba_prepped)

```





--- 

